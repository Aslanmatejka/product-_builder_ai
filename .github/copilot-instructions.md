# Product Builder AI Guide

1. **Prime Directive** — AI decides _what_ to build while FreeCAD/KiCad deterministically create geometry. Never emit CAD scripts; only return structured constraints consumed by `server/services/orchestrator.js`.
2. **System Flow** — `client/src` chat UI → `server/routes/build.js` or `/chat` → `server/services/aiPlanner.js` (Claude Sonnet 4) → `server/services/validator.js` schema check → Python engines in `engine/cad` + `engine/pcb` → artifacts under `exports/`.
3. **Endpoints** — `/api/build` handles single prompts; `/api/chat` keeps `conversationHistory` and `currentDesign` until `{ shouldBuild: true }`. Chat state machine lives in `client/src/App.jsx` and mirrors backend responses.
4. **Frontend Patterns** — `PromptInput.jsx` collects prompts, `BuildStatus.jsx` streams status/reasoning, `components/CanvasView.jsx` pulls STL URLs from `/exports`. Update these when introducing new artifact types.
5. **Run Commands** — `npm run dev:full` starts both tiers; `npm run dev` (Express on :3001) and `npm run client` (:3000) run separately. Use `npm start` for production-style backend.
6. **Environment Vars** — `.env` must include `ANTHROPIC_API_KEY`; optional `PORT` and `AI_MODEL_NAME` change server port/branding. Backend fails fast if the API key is missing.
7. **Design Schema** — Validator enforces `{ product_type, units in ["mm","inches"], length, width, height, wall_thickness ≥ 1.5, features[], pcb_required }`. Missing units, absurd dimensions, or thin walls raise `ValidationError` surfaced to the client.
8. **Child Processes** — Always spawn engines via `child_process.spawn(getFreeCADPython(), ["engine/cad/freecad_generator.py", buildId])` and `spawn("python", ["engine/pcb/kicad_generator.py", buildId])`. Communicate via stdin JSON, parse stdout JSON, treat stderr as warnings/errors.
9. **Tool Detection** — `getFreeCADPython()` hunts FreeCAD’s bundled python on Windows and falls back to system `python`. `freecad_generator.py` / `kicad_generator.py` set `FREECAD_AVAILABLE` / `KICAD_AVAILABLE`; when false they generate placeholder files so higher layers stay testable.
10. **Artifact Layout** — Every buildId yields `exports/cad/<id>.step` + `.stl`; assemblies create `<id>_partN_<Name>.step`. PCB Gerbers drop into `exports/pcb/<id>-layer.gbr` whenever `pcb_required` is true and KiCad is available.
11. **Error Routing** — `server/services/orchestrator.js` prefixes failures as `Design Validation Error`, `AI Planning Error`, `CAD Generation Error`, or `PCB Generation Error`. Preserve stderr text to help users fix Anthropic keys or CAD installs.
12. **CAD Feature Workflow** — Extend the AI prompt in `aiPlanner.js` (`DESIGN_SCHEMA_PROMPT`), add validator coverage, then implement geometry in `engine/cad/freecad_generator.py` using the FreeCAD Part API (never string `exec`). Test via `echo '{...}' | python engine/cad/freecad_generator.py build-id`.
13. **PCB Component Workflow** — Add symbols/footprints/defaults in `engine/pcb/kicad_lib_mapper.js`, mirror identifiers in `engine/pcb/kicad_generator.py` `FOOTPRINT_LIBRARY_MAP`, and ensure `expandComponentsWithLibraries()` feeds the orchestrator with fully qualified parts.
14. **Chat + Build Logic** — `aiPlanner.chatWithEngineer()` keeps iterating until enough detail exists. When modifying existing designs, merge deltas into `currentDesign` so dimensions persist between user turns.
15. **Testing Shortcuts** — Smoke-test backend with `curl -X POST http://localhost:3001/api/build -H "Content-Type: application/json" -d '{"prompt":"battery cover 80x40x10mm"}'`. Run `npm run dev` logs to watch `[CAD ERROR]` / `[PCB ERROR]` output.
16. **Troubleshooting Tools** — Validate installs with `python -c "import FreeCAD"` and `python -c "import pcbnew"`. If builds hang, ensure Python stdin closes and JSON is valid (wrap child output parsing in try/catch).
17. **Client Error UX** — `client/src/ErrorBoundary.jsx` and `App.jsx` show orchestrator messages verbatim. Provide actionable guidance like “Install FreeCAD 0.21+” or “Add units in prompt” when throwing.
18. **Security & Safety** — Never execute AI-generated FreeCAD/KiCad code. Keep child process inputs sanitized JSON only; geometry lives solely inside deterministic Python engines.
19. **Doc References** — Architecture details in `docs/COPILOT_CONTEXT.md`; setup/run expectations in `README.md`, `QUICKSTART.md`, `DEVELOPMENT.md`. Read these before touching schema, prompt, or engine contracts.
20. **When Unsure** — Trace the chain (prompt → aiPlanner → validator → orchestrator → engines → exports). Any change impacting this flow must add logging so other agents can diagnose quickly.
